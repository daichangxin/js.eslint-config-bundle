name: publish npm package
on:
    push:
        branches: [master, main]

permissions:
  contents: write         # Required for git push and standard-version
  id-token: write         # Required for npm Trusted Publisher

jobs:
    auto_release_npm_package:
        runs-on: ubuntu-latest
        if: "!contains(github.event.head_commit.message, 'skip ci')"
        steps:
          - uses: actions/checkout@v4
            with:
              fetch-depth: 0  # Required for standard-version to work properly
          - uses: actions/setup-node@v4
            with:
              node-version: 20.x
              registry-url: 'https://registry.npmjs.org'
          - name: setup
            run: |
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              git checkout ${{ github.ref_name }}
              npm install --legacy-peer-deps
          - name: build
            run: |
              npm run build --if-present
          - name: test
            run: |
              npm run test --if-present
          - name: version and publish
            run: |
              SPACE_CHAR=" "
              npx standard-version --releaseCommitMessageFormat "chore(release):${SPACE_CHAR}{{currentTag}} [skip ci]"
              npm publish --access public --provenance
              git push --follow-tags origin ${{ github.ref_name }}

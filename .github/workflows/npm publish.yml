name: Manual Publish npm Package
on:
  workflow_dispatch:
    inputs:
      otp:
        description: 'npm Two-Factor Authentication Code (6 digits)'
        required: true
        type: string

permissions:
  contents: write         # Required for git push and standard-version
  id-token: write         # Required for npm Trusted Publisher

jobs:
    manual_release_npm_package:
        runs-on: ubuntu-latest
        steps:
          - uses: actions/checkout@v4
            with:
              fetch-depth: 0  # Required for standard-version to work properly
          - uses: actions/setup-node@v4
            with:
              node-version: 20.x
              registry-url: 'https://registry.npmjs.org'
          - name: setup
            run: |
              git config --local user.email "action@github.com"
              git config --local user.name "GitHub Action"
              npm install --legacy-peer-deps
          - name: build
            run: |
              npm run build --if-present
          - name: test
            run: |
              npm run test --if-present
          - name: version bump
            run: |
              SPACE_CHAR=" "
              npx standard-version --releaseCommitMessageFormat "chore(release):${SPACE_CHAR}{{currentTag}} [skip ci]"

          - name: publish to npm with 2FA
            run: |
              npm publish --access public --otp=${{ github.event.inputs.otp }}

          - name: push changes
            run: |
              git push --follow-tags origin ${{ github.ref_name }}
